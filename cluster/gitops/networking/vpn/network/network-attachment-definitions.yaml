# These NADs are for the VPN gateway network.
---
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: gateway-network-vpn-gateway-pods
spec:
  config: |
    {
      "cniVersion": "0.3.0",
      "name": "gateway-network-vpn-gateway-pods",
      "type": "bridge",
      "bridge": "vpn-gw-bridge0",
      "ipam": {
        "type": "whereabouts",
        "range": "192.168.24.0/22",
        "range_start": "192.168.25.1",
        "range_end": "192.168.50.254"
      },
      "mtu": 1420
    }
---
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: gateway-network-router-pods
spec:
  config: |
    {
      "cniVersion": "0.3.0",
      "name": "gateway-network-router-pods",
      "type": "bridge",
      "bridge": "vpn-gw-bridge0",
      "ipam": {
        "type": "whereabouts",
        "range": "192.168.24.0/22",
        "range_start": "192.168.26.1",
        "range_end": "192.168.26.127"
      },
      "mtu": 1420
    }
---
# TODO see if client pods set subnet can be reduced to /32 despite gateway not being in that subnet (on link route)
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: gateway-network-client-pods
spec:
  config: |
    {
      "cniVersion": "0.3.0",
      "name": "gateway-network-client-pods",
      "type": "bridge",
      "bridge": "vpn-gw-bridge0",
      "ipam": {
        "type": "whereabouts",
        "range": "192.168.24.0/24",
        "range_start": "192.168.24.1",
        "range_end": "192.168.24.254",
        "routes": [
          {"dst": "0.0.0.0/5"},
          {"dst": "8.0.0.0/7"},
          {"dst": "11.0.0.0/8"},
          {"dst": "12.0.0.0/6"},
          {"dst": "16.0.0.0/4"},
          {"dst": "32.0.0.0/3"},
          {"dst": "64.0.0.0/2"},
          {"dst": "128.0.0.0/1"}
        ],
        "gateway": "192.168.26.254"
      },
      "mtu": 1420
    }
...
# Client pod NADs for pods that can receive VPN ingress traffic.
# As an alternative to these, pods could set the following annotation:
#
# ```yaml
# k8s.v1.cni.cncf.io/networks: >
#   [
#     {
#       "name": "gateway-network-client-pods",
#       "interface": "vpn-gw-veth0",
#       "ips": [
#         "192.168.27.<PORT NUMBER>/24"
#       ]
#     }
#   ]
# ```
#
# Personally I find this a little harder to read and understand than several dedicated NADs
# with clear names. The tradeoff is that the below is pretty verbose, but at least it is
# all in one place.
---
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: gateway-network-client-pods-forwarded-port-1
spec:
  config: |
    {
      "cniVersion": "0.3.0",
      "name": "gateway-network-client-pods-forwarded-port-1",
      "type": "bridge",
      "bridge": "vpn-gw-bridge0",
      "ipam": {
        "type": "whereabouts",
        "range": "192.168.24.0/24",
        "range_start": "192.168.27.1",
        "range_end": "192.168.27.15",
        "routes": [
          {"dst": "0.0.0.0/5"},
          {"dst": "8.0.0.0/7"},
          {"dst": "11.0.0.0/8"},
          {"dst": "12.0.0.0/6"},
          {"dst": "16.0.0.0/4"},
          {"dst": "32.0.0.0/3"},
          {"dst": "64.0.0.0/2"},
          {"dst": "128.0.0.0/1"}
        ],
        "gateway": "192.168.26.254"
      },
      "mtu": 1420
    }
---
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: gateway-network-client-pods-forwarded-port-2
spec:
  config: |
    {
      "cniVersion": "0.3.0",
      "name": "gateway-network-client-pods-forwarded-port-2",
      "type": "bridge",
      "bridge": "vpn-gw-bridge0",
      "ipam": {
        "type": "whereabouts",
        "range": "192.168.24.0/24",
        "range_start": "192.168.27.16",
        "range_end": "192.168.27.31",
        "routes": [
          {"dst": "0.0.0.0/5"},
          {"dst": "8.0.0.0/7"},
          {"dst": "11.0.0.0/8"},
          {"dst": "12.0.0.0/6"},
          {"dst": "16.0.0.0/4"},
          {"dst": "32.0.0.0/3"},
          {"dst": "64.0.0.0/2"},
          {"dst": "128.0.0.0/1"}
        ],
        "gateway": "192.168.26.254"
      },
      "mtu": 1420
    }
---
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: gateway-network-client-pods-forwarded-port-3
spec:
  config: |
    {
      "cniVersion": "0.3.0",
      "name": "gateway-network-client-pods-forwarded-port-3",
      "type": "bridge",
      "bridge": "vpn-gw-bridge0",
      "ipam": {
        "type": "whereabouts",
        "range": "192.168.24.0/24",
        "range_start": "192.168.27.32",
        "range_end": "192.168.27.47",
        "routes": [
          {"dst": "0.0.0.0/5"},
          {"dst": "8.0.0.0/7"},
          {"dst": "11.0.0.0/8"},
          {"dst": "12.0.0.0/6"},
          {"dst": "16.0.0.0/4"},
          {"dst": "32.0.0.0/3"},
          {"dst": "64.0.0.0/2"},
          {"dst": "128.0.0.0/1"}
        ],
        "gateway": "192.168.26.254"
      },
      "mtu": 1420
    }
---
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: gateway-network-client-pods-forwarded-port-4
spec:
  config: |
    {
      "cniVersion": "0.3.0",
      "name": "gateway-network-client-pods-forwarded-port-4",
      "type": "bridge",
      "bridge": "vpn-gw-bridge0",
      "ipam": {
        "type": "whereabouts",
        "range": "192.168.24.0/24",
        "range_start": "192.168.27.48",
        "range_end": "192.168.27.63",
        "routes": [
          {"dst": "0.0.0.0/5"},
          {"dst": "8.0.0.0/7"},
          {"dst": "11.0.0.0/8"},
          {"dst": "12.0.0.0/6"},
          {"dst": "16.0.0.0/4"},
          {"dst": "32.0.0.0/3"},
          {"dst": "64.0.0.0/2"},
          {"dst": "128.0.0.0/1"}
        ],
        "gateway": "192.168.26.254"
      },
      "mtu": 1420
    }
---
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: gateway-network-client-pods-forwarded-port-5
spec:
  config: |
    {
      "cniVersion": "0.3.0",
      "name": "gateway-network-client-pods-forwarded-port-5",
      "type": "bridge",
      "bridge": "vpn-gw-bridge0",
      "ipam": {
        "type": "whereabouts",
        "range": "192.168.24.0/24",
        "range_start": "192.168.27.64",
        "range_end": "192.168.27.79",
        "routes": [
          {"dst": "0.0.0.0/5"},
          {"dst": "8.0.0.0/7"},
          {"dst": "11.0.0.0/8"},
          {"dst": "12.0.0.0/6"},
          {"dst": "16.0.0.0/4"},
          {"dst": "32.0.0.0/3"},
          {"dst": "64.0.0.0/2"},
          {"dst": "128.0.0.0/1"}
        ],
        "gateway": "192.168.26.254"
      },
      "mtu": 1420
    }
...
# These NADs are for the router pod network.
# TODO all pods in all namespaces can reference this NAD with how I have multus configured.
# Need to restrict this one to just the router pods.
---
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: gateway-router-network
spec:
  config: |
    {
      "cniVersion": "0.3.0",
      "name": "gateway-router-network",
      "type": "bridge",
      "bridge": "vpn-r-bridge0",
      "ipam": {
        "type": "whereabouts",
        "range": "192.168.28.0/24"
      },
      "mtu": 8950
    }
