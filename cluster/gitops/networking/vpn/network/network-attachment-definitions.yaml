# These NADs are for the VPN gateway network.
# Any routes for 10.33.0.10/32 are to ensure that DNS requests go to the VPN DNS pods
# rather than the cluster DNS service. By using this route and DNATing the requests
# on the router, the client pods don't need to have any special configuration to use
# the VPN DNS servers.
---
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: gateway-network-vpn-gateway-pods
spec:
  config: |
    {
      "cniVersion": "0.3.0",
      "name": "gateway-network-vpn-gateway-pods",
      "type": "bridge",
      "bridge": "vpn-gw-bridge0",
      "ipam": {
        "type": "whereabouts",
        "range": "192.168.24.0/22",
        "range_start": "192.168.25.128",
        "range_end": "192.168.25.135",
        "routes": [
          {"dst": "10.33.0.10/32", "gw": "192.168.26.254"}
        ]
      },
      "mtu": 1420
    }
---
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: gateway-network-router-pods
spec:
  config: |
    {
      "cniVersion": "0.3.0",
      "name": "gateway-network-router-pods",
      "type": "bridge",
      "bridge": "vpn-gw-bridge0",
      "ipam": {
        "type": "whereabouts",
        "range": "192.168.24.0/22",
        "range_start": "192.168.26.0",
        "range_end": "192.168.26.127",
        "routes": [
          {"dst": "10.33.0.10/32", "gw": "192.168.26.254"}
        ]
      },
      "mtu": 1420
    }
---
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: gateway-network-client-pods
spec:
  config: |
    {
      "cniVersion": "0.3.0",
      "name": "gateway-network-client-pods",
      "type": "bridge",
      "bridge": "vpn-gw-bridge0",
      "ipam": {
        "type": "whereabouts",
        "range": "192.168.24.0/22",
        "range_start": "192.168.24.1",
        "range_end": "192.168.24.127",
        "routes": [
          {"dst": "10.33.0.10/32"},
          {"dst": "0.0.0.0/5"},
          {"dst": "8.0.0.0/7"},
          {"dst": "11.0.0.0/8"},
          {"dst": "12.0.0.0/6"},
          {"dst": "16.0.0.0/4"},
          {"dst": "32.0.0.0/3"},
          {"dst": "64.0.0.0/2"},
          {"dst": "128.0.0.0/1"}
        ],
        "gateway": "192.168.26.254"
      },
      "mtu": 1420
    }
...
# Client pod NADs for pods that can receive VPN ingress traffic.
# As an alternative to these, pods could set the following annotation:
#
# ```yaml
# k8s.v1.cni.cncf.io/networks: >
#   [
#     {
#       "name": "gateway-network-client-pods",
#       "interface": "vpn-gw-veth0",
#       "ips": [
#         "192.168.27.<PORT NUMBER>/24"
#       ]
#     }
#   ]
# ```
#
# Personally I find this a little harder to read and understand than several dedicated NADs
# with clear names. The tradeoff is that the below is pretty verbose, but at least it is
# all in one place.
---
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: gateway-network-client-pods-forwarded-port-1
spec:
  config: |
    {
      "cniVersion": "0.3.0",
      "name": "gateway-network-client-pods-forwarded-port-1",
      "type": "bridge",
      "bridge": "vpn-gw-bridge0",
      "ipam": {
        "type": "whereabouts",
        "range": "192.168.24.0/22",
        "range_start": "192.168.27.0",
        "range_end": "192.168.27.15",
        "routes": [
          {"dst": "10.33.0.10/32"},
          {"dst": "0.0.0.0/5"},
          {"dst": "8.0.0.0/7"},
          {"dst": "11.0.0.0/8"},
          {"dst": "12.0.0.0/6"},
          {"dst": "16.0.0.0/4"},
          {"dst": "32.0.0.0/3"},
          {"dst": "64.0.0.0/2"},
          {"dst": "128.0.0.0/1"}
        ],
        "gateway": "192.168.26.254"
      },
      "mtu": 1420
    }
---
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: gateway-network-client-pods-forwarded-port-2
spec:
  config: |
    {
      "cniVersion": "0.3.0",
      "name": "gateway-network-client-pods-forwarded-port-2",
      "type": "bridge",
      "bridge": "vpn-gw-bridge0",
      "ipam": {
        "type": "whereabouts",
        "range": "192.168.24.0/22",
        "range_start": "192.168.27.16",
        "range_end": "192.168.27.31",
        "routes": [
          {"dst": "10.33.0.10/32"},
          {"dst": "0.0.0.0/5"},
          {"dst": "8.0.0.0/7"},
          {"dst": "11.0.0.0/8"},
          {"dst": "12.0.0.0/6"},
          {"dst": "16.0.0.0/4"},
          {"dst": "32.0.0.0/3"},
          {"dst": "64.0.0.0/2"},
          {"dst": "128.0.0.0/1"}
        ],
        "gateway": "192.168.26.254"
      },
      "mtu": 1420
    }
---
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: gateway-network-client-pods-forwarded-port-3
spec:
  config: |
    {
      "cniVersion": "0.3.0",
      "name": "gateway-network-client-pods-forwarded-port-3",
      "type": "bridge",
      "bridge": "vpn-gw-bridge0",
      "ipam": {
        "type": "whereabouts",
        "range": "192.168.24.0/22",
        "range_start": "192.168.27.32",
        "range_end": "192.168.27.47",
        "routes": [
          {"dst": "10.33.0.10/32"},
          {"dst": "0.0.0.0/5"},
          {"dst": "8.0.0.0/7"},
          {"dst": "11.0.0.0/8"},
          {"dst": "12.0.0.0/6"},
          {"dst": "16.0.0.0/4"},
          {"dst": "32.0.0.0/3"},
          {"dst": "64.0.0.0/2"},
          {"dst": "128.0.0.0/1"}
        ],
        "gateway": "192.168.26.254"
      },
      "mtu": 1420
    }
---
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: gateway-network-client-pods-forwarded-port-4
spec:
  config: |
    {
      "cniVersion": "0.3.0",
      "name": "gateway-network-client-pods-forwarded-port-4",
      "type": "bridge",
      "bridge": "vpn-gw-bridge0",
      "ipam": {
        "type": "whereabouts",
        "range": "192.168.24.0/22",
        "range_start": "192.168.27.48",
        "range_end": "192.168.27.63",
        "routes": [
          {"dst": "10.33.0.10/32"},
          {"dst": "0.0.0.0/5"},
          {"dst": "8.0.0.0/7"},
          {"dst": "11.0.0.0/8"},
          {"dst": "12.0.0.0/6"},
          {"dst": "16.0.0.0/4"},
          {"dst": "32.0.0.0/3"},
          {"dst": "64.0.0.0/2"},
          {"dst": "128.0.0.0/1"}
        ],
        "gateway": "192.168.26.254"
      },
      "mtu": 1420
    }
---
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: gateway-network-client-pods-forwarded-port-5
spec:
  config: |
    {
      "cniVersion": "0.3.0",
      "name": "gateway-network-client-pods-forwarded-port-5",
      "type": "bridge",
      "bridge": "vpn-gw-bridge0",
      "ipam": {
        "type": "whereabouts",
        "range": "192.168.24.0/22",
        "range_start": "192.168.27.64",
        "range_end": "192.168.27.79",
        "routes": [
          {"dst": "10.33.0.10/32"},
          {"dst": "0.0.0.0/5"},
          {"dst": "8.0.0.0/7"},
          {"dst": "11.0.0.0/8"},
          {"dst": "12.0.0.0/6"},
          {"dst": "16.0.0.0/4"},
          {"dst": "32.0.0.0/3"},
          {"dst": "64.0.0.0/2"},
          {"dst": "128.0.0.0/1"}
        ],
        "gateway": "192.168.26.254"
      },
      "mtu": 1420
    }
...
# NADs for specific services so that they have a consistent set of addresses
---
# The first route overrides the link-scoped prefix route that is automatically added
# by the kernel when the veth interface is created. This ensures that all traffic is
# routed instead of switched, which is important to ensure that clients receive the
# DNS responses with the correct source IP address.
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: gateway-network-dns-pods
spec:
  config: |
    {
      "cniVersion": "0.3.0",
      "name": "gateway-network-dns-pods",
      "type": "bridge",
      "bridge": "vpn-gw-bridge0",
      "ipam": {
        "type": "whereabouts",
        "range": "192.168.24.0/22",
        "range_start": "192.168.27.128",
        "range_end": "192.168.27.130",
        "routes": [
          {"dst": "192.168.24.0/22"},
          {"dst": "0.0.0.0/5"},
          {"dst": "8.0.0.0/7"},
          {"dst": "11.0.0.0/8"},
          {"dst": "12.0.0.0/6"},
          {"dst": "16.0.0.0/4"},
          {"dst": "32.0.0.0/3"},
          {"dst": "64.0.0.0/2"},
          {"dst": "128.0.0.0/1"}
        ],
        "gateway": "192.168.26.254"
      },
      "mtu": 1420
    }
...
# These NADs are for the router pod network.
# TODO all pods in all namespaces can reference this NAD with how I have multus configured.
# Need to restrict this one to just the router pods.
---
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: gateway-router-network
spec:
  config: |
    {
      "cniVersion": "0.3.0",
      "name": "gateway-router-network",
      "type": "bridge",
      "bridge": "vpn-r-bridge0",
      "ipam": {
        "type": "whereabouts",
        "range": "192.168.28.0/24"
      },
      "mtu": 8950
    }
...
# These NADs are for the active-passive, single gateway network.
# This network is needed for some specific applications that require a stable egress IP address,
# such as tools that need to bypass cloudflare captchas.
---
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: gateway-single-router-network
spec:
  config: |
    {
      "cniVersion": "0.3.0",
      "name": "gateway-single-router-network",
      "type": "bridge",
      "bridge": "vpn-r-bridge0",
      "ipam": {
        "type": "whereabouts",
        "range": "192.168.29.0/24"
      },
      "mtu": 8950
    }
---
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: gateway-network-single-router-client-pods
spec:
  config: |
    {
      "cniVersion": "0.3.0",
      "name": "gateway-network-single-router-client-pods",
      "type": "bridge",
      "bridge": "vpn-gw-bridge0",
      "ipam": {
        "type": "whereabouts",
        "range": "192.168.24.0/22",
        "range_start": "192.168.24.128",
        "range_end": "192.168.24.255",
        "routes": [
          {"dst": "10.33.0.10/32"},
          {"dst": "0.0.0.0/5"},
          {"dst": "8.0.0.0/7"},
          {"dst": "11.0.0.0/8"},
          {"dst": "12.0.0.0/6"},
          {"dst": "16.0.0.0/4"},
          {"dst": "32.0.0.0/3"},
          {"dst": "64.0.0.0/2"},
          {"dst": "128.0.0.0/1"}
        ],
        "gateway": "192.168.26.253"
      },
      "mtu": 1420
    }
