# These links are for the VPN gateway network.
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/solidDoWant/node-network-operator/refs/tags/v0.0.6/schemas/link_v1alpha1.json
# This is the link that pods will join to via the bridge CNI plugin. The bridge VNI plugins will add one end of a veth pair to this bridge, and
# the other end to the pod's network namespace.
# This bridge will also have a VXLAN interface added to it, so that pods can communicate across nodes.
apiVersion: nodenetworkoperator.soliddowant.dev/v1alpha1
kind: Link
metadata:
  name: vpn-gateway-bridge
spec:
  # This must be 15 characters or less.
  interfaceName: vpn-gw-bridge0
  bridge:
    # This matches the wireguard MTU, which is the limiting factor for the VPN gateway network.
    mtu: 1420
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/solidDoWant/node-network-operator/refs/tags/v0.0.6/schemas/link_v1alpha1.json
# This is the link that the VXLAN should use for transceiving packets. This is a virtual device (a bond), but it
# is can transceive packets between nodes.
apiVersion: nodenetworkoperator.soliddowant.dev/v1alpha1
kind: Link
metadata:
  name: vpn-gateway-vxlan-dev
spec:
  interfaceName: bond0
  # Important: This link type means that other links can _reference_ it, but the operator itself will not change anything about the link.
  # The operator will just assume that the link exists and is properly configured.
  unmanaged: {}
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/solidDoWant/node-network-operator/refs/tags/v0.0.6/schemas/link_v1alpha1.json
# The VXLAN links deployed by this connect the bridges on each node to each other, allowing pods to communicate across nodes.
apiVersion: nodenetworkoperator.soliddowant.dev/v1alpha1
kind: Link
metadata:
  name: vpn-gateway-vxlan
spec:
  interfaceName: vpn-gw-vxlan0
  vxlan:
    # This is an arbitrary value but it needs to be unique across all VXLANs in the cluster.
    vnid: 1000
    # This address is subnet-local, and will not be propagated to other subnets by routers.
    remoteIPAddress: 224.0.0.88
    # This is the device that will carry the VXLAN traffic.
    device:
      name: vpn-gateway-vxlan-dev
    # Tie the interface to the bridge so that pods veth interfaces can send traffic over the VXLAN.
    master:
      name: vpn-gateway-bridge
    # This matches the wireguard MTU, which is the limiting factor for the VPN gateway network.
    # It is also more than 50 bytes smaller than the underlying bond0 MTU of 9000.
    mtu: 1420
...
# These links are for the router pod network (conntrackd + keepalived syncing).
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/solidDoWant/node-network-operator/refs/tags/v0.0.6/schemas/link_v1alpha1.json
apiVersion: nodenetworkoperator.soliddowant.dev/v1alpha1
kind: Link
metadata:
  name: vpn-router-bridge
spec:
  interfaceName: vpn-r-bridge0
  bridge: {}
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/solidDoWant/node-network-operator/refs/tags/v0.0.6/schemas/link_v1alpha1.json
apiVersion: nodenetworkoperator.soliddowant.dev/v1alpha1
kind: Link
metadata:
  name: vpn-router-vxlan-dev
spec:
  interfaceName: bond0
  unmanaged: {}
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/solidDoWant/node-network-operator/refs/tags/v0.0.6/schemas/link_v1alpha1.json
apiVersion: nodenetworkoperator.soliddowant.dev/v1alpha1
kind: Link
metadata:
  name: vpn-router-vxlan
spec:
  interfaceName: vpn-r-vxlan0
  vxlan:
    vnid: 2000
    # Multiple VXLANs can use the same multicast address, but they must have different VNIDs.
    remoteIPAddress: 224.0.0.88
    device:
      name: vpn-router-vxlan-dev
    master:
      name: vpn-router-bridge
    mtu: 8950
