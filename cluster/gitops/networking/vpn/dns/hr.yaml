---
# yaml-language-server: $schema=https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: coredns-vpn-dns
spec:
  interval: 1h
  chart:
    spec:
      chart: coredns
      reconcileStrategy: ChartVersion
      sourceRef:
        kind: HelmRepository
        namespace: flux-system
        name: coredns-charts
      version: 1.43.3
  # These values are added now that the cluster has been bootstrapped
  values:
    replicaCount: 2
    prometheus:
      service:
        enabled: true
      monitor:
        enabled: true
    service:
      name: vpn-dns
    serviceAccount:
      create: true
    isClusterService: false
    priorityClassName: system-cluster-critical
    # Containerd 2.0 enables binding to port numbers <= 1024 by default, so the
    # NET_BIND_SERVICE capability is not needed
    # For some weird reason as of 1.12.3 this is needed or the entrypoint fails
    # with "permission denied" upon `exec`.
    # securityContext:
    #   capabilities:
    #     add: []
    servers:
      - zones:
          - zone: .
            scheme: dns://
            use_tcp: true
        port: 53
        plugins:
          - name: errors
          - name: health
            configBlock: lameduck 5s
          - name: ready
          - name: log
          - name: prometheus
            parameters: 0.0.0.0:9153 # Default is localhost only
          - name: reload
          - name: loop
          - name: loadbalance
          # Reject requests from public IP space
          # This shouldn't happen - this config is just a precaution
          - name: acl
            configBlock: |-
              allow net 192.168.24.0/22
              drop
          - name: whoami
          - name: kubernetes
            parameters: cluster.local in-addr.arpa
            configBlock: |-
              pods verified
              fallthrough in-addr.arpa
          # Resolve PTR records for services
          - name: k8s_external
            parameters: in-addr.arpa
            configBlock: |-
              fallthrough in-addr.arpa
          # Fix PTR record lookups
          - name: rewrite
            parameters: stop
            configBlock: |-
              name suffix .in-addr.arpa. .in-addr.arpa.
              answer name auto
              answer value (.*)\.cluster\.local\. {1}.cluster.local
          - name: cache
            parameters: 30
          # Forward everything else to public servers, which are only reachable via the VPN gateway
          - name: forward
            parameters: . ${SECRET_DNS_FORWARDERS}
            configBlock: |-
              policy random
              health_check 1s
              failfast_all_unhealthy_upstreams
    podAnnotations:
      k8s.v1.cni.cncf.io/networks: gateway-network-dns-pods@vpn-gw-veth0
    livenessProbe:
      initialDelaySeconds: 5
    readinessProbe:
      initialDelaySeconds: 5
    podDisruptionBudget:
      minAvailable: 1
    k8sAppLabelOverride: vpn-dns
