---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/kyverno.io/policy_v1.json
# This is needed to construct the S3 URL. The bucket name has a random suffix,
# so its value isn't known ahead of time.
apiVersion: kyverno.io/v1
kind: Policy
metadata:
  name: build-teleport-audit-sessions-bucket-env-vars
spec:
  rules:
    - # Trigger on change of any of these resources
      name: build-teleport-audit-sessions-bucket-env-vars
      match:
        any:
          - resources:
              kinds:
                - Secret
              name: teleport-audit-sessions
      skipBackgroundRequests: true
      generate:
        generateExisting: true
        synchronize: true
        apiVersion: v1
        kind: Secret
        name: teleport-audit-sessions-url
        namespace: security
        data:
          type: Opaque
          stringData:
            values.yaml: |
              {{ postgresAuthCa | base64_decode(@) }}
