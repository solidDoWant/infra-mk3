---
# yaml-language-server: $schema=./schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: teleport-agent
spec:
  interval: 5m
  chart:
    spec:
      chart: teleport-kube-agent
      sourceRef:
        kind: HelmRepository
        name: teleport-charts
      version: 17.0.2
  values:
    roles: db
    proxyAddr: teleport.${SECRET_PUBLIC_DOMAIN_NAME}:443
    enterprise: true
    joinParams:
      method: kubernetes
      tokenName: teleport-kube-agent
    databaseResources:
      - labels:
          teleport.home.arpa/database.enabled: "true"
    updater:
      # Make absolutely certain that the auto updater is never enabled
      enabled: false
    highAvailability:
      podDisruptionBudget:
        enabled: true
        minAvailable: 1
      replicaCount: 2
    podMonitor:
      enabled: true
  # TODO enable TSC
  # postRenderers:
