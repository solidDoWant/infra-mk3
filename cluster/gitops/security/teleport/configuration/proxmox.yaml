---
# yaml-language-server: $schema=../../../../../schemas/crds/teleportprovisiontoken_v2.json
apiVersion: resources.teleport.dev/v2
kind: TeleportProvisionToken
metadata:
  name: proxmox-vm-host-01
  # Make the token last a long time
  # This isn't a huge risk because Kubernetes will be used to verify the identity of the
  # requester
  # Currently bugged, see https://github.com/gravitational/teleport/issues/49925
  # expires: "2030-01-01T00:00:00Z"
spec:
  roles:
    - Node
  join_method: tpm
  tpm:
    # Pulled via
    # cat <<EOF > ekcert.pem
    # -----BEGIN CERTIFICATE-----
    # $(tpm2_getekcertificate | base64)
    # -----END CERTIFICATE-----
    # EOF
    ekcert_allowed_cas:
      - |
        -----BEGIN CERTIFICATE-----
        MIID2TCCA4CgAwIBAgIKZdJB+bfDsTwcrDAKBggqhkjOPQQDAjBVMVMwHwYDVQQDExhOdXZvdG9u
        IFRQTSBSb290IENBIDExMTAwJQYDVQQKEx5OdXZvdG9uIFRlY2hub2xvZ3kgQ29ycG9yYXRpb24w
        CQYDVQQGEwJUVzAeFw0yMzA2MDQxNzA0NTlaFw00MzA1MzExNzA0NTlaMAAwggEiMA0GCSqGSIb3
        DQEBAQUAA4IBDwAwggEKAoIBAQC8E77U8Xov4/ZShVlcnrVpNHyovqT5U82XlaBRXMdmFRs/OnTk
        4eEiGM4a+uT0c45Fq0Tf2R/JJyGUx0EB6ZSbsaHI3dSOzFlnzAaY+DjWhFFMZIgpx8lmYhk3CAsI
        YECMAdq450ZjRCfnw0oZiaMGU9GS2bUBrgzCXtoEfBfUwRT8ciK+s8nbfZWxjhUCt4p+WN2hsPp0
        jQJW8tL+wXI38D0IwXaktMNldEgK/EGLeIz/V06wXumPcHMDQmruFj+eTZbIMfBx4tfBeaKjf9S6
        GGDds2AsAIG4SG83KbUaLeVuatHLgfYXxtJsBHX3sm8iftclr4dskcledHCKtuwZAgMBAAGjggHA
        MIIBvDBKBgNVHREBAf8EQDA+pDwwOjE4MBQGBWeBBQIBEwtpZDo0RTU0NDMwMDAQBgVngQUCAhMH
        TlBDVDZ4eDAOBgVngQUCAxMFaWQ6MTMwDAYDVR0TAQH/BAIwADAQBgNVHSUECTAHBgVngQUIATAf
        BgNVHSMEGDAWgBQVkdS26vmNAQSGS2kDpI3QAmB30zAOBgNVHQ8BAf8EBAMCBSAwcAYDVR0JBGkw
        ZzAWBgVngQUCEDENMAsMAzIuMAIBAAIBdDBNBgVngQUCEjFEMEICAQABAf+gAwoBAaEDCgEAogMK
        AQCjFTATFgMzLjEKAQQKAQEBAf+gAwoBAqQPMA0WBTE0MC0yCgECAQEApQMBAQAwQQYDVR0gBDow
        ODA2BgRVHSAAMC4wLAYIKwYBBQUHAgEWIGh0dHA6Ly93d3cubnV2b3Rvbi5jb20vc2VjdXJpdHkv
        MGgGCCsGAQUFBwEBBFwwWjBYBggrBgEFBQcwAoZMaHR0cDovL3d3dy5udXZvdG9uLmNvbS9zZWN1
        cml0eS9OVEMtVFBNLUVLLUNlcnQvTnV2b3RvbiBUUE0gUm9vdCBDQSAxMTEwLmNlcjAKBggqhkjO
        PQQDAgNHADBEAiBZOkeCYCo8dizkb9jUxQyyimUPASvLBBi2ERh+MQn3sQIgU5ble7G6/9zXaFyC
        Iy7IPK5H0S0htG/KvkySFQd9LagwggMRMIICtqADAgECAgsAyyYhKYjmOCuM1jAKBggqhkjOPQQD
        AjBVMVMwHwYDVQQDExhOdXZvdG9uIFRQTSBSb290IENBIDExMTAwJQYDVQQKEx5OdXZvdG9uIFRl
        Y2hub2xvZ3kgQ29ycG9yYXRpb24wCQYDVQQGEwJUVzAeFw0yMzA2MDQxNzA0NTlaFw00MzA1MzEx
        NzA0NTlaMAAwWTATBgcqhkjOPQIBBggqhkjOPQMBBwNCAARPekZzvL9PmbNUhlweIJsOgvswEjUF
        NQpudtzMpob+3ax2Z/ChlK3x4+GgujvMAOELj4ITEyMME1f9/DXUW5Aho4IBwDCCAbwwSgYDVR0R
        AQH/BEAwPqQ8MDoxODAUBgVngQUCARMLaWQ6NEU1NDQzMDAwEAYFZ4EFAgITB05QQ1Q2eHgwDgYF
        Z4EFAgMTBWlkOjEzMAwGA1UdEwEB/wQCMAAwEAYDVR0lBAkwBwYFZ4EFCAEwHwYDVR0jBBgwFoAU
        FZHUtur5jQEEhktpA6SN0AJgd9MwDgYDVR0PAQH/BAQDAgUgMHAGA1UdCQRpMGcwFgYFZ4EFAhAx
        DTALDAMyLjACAQACAXQwTQYFZ4EFAhIxRDBCAgEAAQH/oAMKAQGhAwoBAKIDCgEAoxUwExYDMy4x
        CgEECgEBAQH/oAMKAQKkDzANFgUxNDAtMgoBAgEBAKUDAQEAMEEGA1UdIAQ6MDgwNgYEVR0gADAu
        MCwGCCsGAQUFBwIBFiBodHRwOi8vd3d3Lm51dm90b24uY29tL3NlY3VyaXR5LzBoBggrBgEFBQcB
        AQRcMFowWAYIKwYBBQUHMAKGTGh0dHA6Ly93d3cubnV2b3Rvbi5jb20vc2VjdXJpdHkvTlRDLVRQ
        TS1FSy1DZXJ0L051dm90b24gVFBNIFJvb3QgQ0EgMTExMC5jZXIwCgYIKoZIzj0EAwIDSQAwRgIh
        AL2urn/Yw81Kwi7ZRykfvf7t4nutBCuPDAQF/MXnZVtVAiEAiTT2XKSJHKPNsfxMnGpwnNKJggte
        a2rlPd1SulOqcMk=
        -----END CERTIFICATE-----
    allow:
      - description: proxmox-vm-host-01
        # Pulled from `teleport tpm identify` on the node
        ek_public_hash: 52968b314d5f3cee62f098d3ca6d0fd9155216ae33f313d5a2e9948e4460b5b5
