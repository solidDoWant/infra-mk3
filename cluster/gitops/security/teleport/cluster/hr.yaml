---
# yaml-language-server: $schema=./schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: teleport-cluster
spec:
  interval: 5m
  chart:
    spec:
      chart: teleport-cluster
      sourceRef:
        kind: HelmRepository
        name: teleport-charts
      version: 17.0.2
  valuesFrom:
    # S3 URL
    - kind: ConfigMap
      name: teleport-audit-sessions-url
      valuesKey: url
      targetPath: .auth.teleportConfig.teleport.storage.audit_sessions_url
  values:
    clusterName: teleport.${SECRET_PUBLIC_DOMAIN_NAME}
    kubeClusterName: infra-mk3
    proxyProtocol: off
    auth:
      teleportConfig:
        teleport:
          storage:
            type: postgresql
            conn_string: "\
              postgresql://\
              teleport-core@teleport-core-postgres-17-rw.security.svc.cluster.local:5432/teleport-core?\
              pool_max_conns=20\
              sslrootcert=/etc/teleport-backend/secrets/core/server/ca.crt\
              sslcert=/etc/teleport-backend/secrets/core/client/tls.crt\
              sslkey=/etc/teleport-backend/secrets/core/client/tls.key\
              sslmode=verify-full"
            audit_events_uri: "\
              postgresql://\
              teleport-audit@teleport-audit-postgres-17-rw.security.svc.cluster.local:5432/teleport-audit?\
              sslrootcert=/etc/teleport-backend/secrets/audit/server/ca.crt\
              sslcert=/etc/teleport-backend/secrets/audit/client/tls.crt\
              sslkey=/etc/teleport-backend/secrets/audit/client/tls.key\
              sslmode=verify-full"
            audit_sessions_uri:
      extraVolumes:
        - name: intermediary-ca-cert
          secret:
            secretName: security-intermediary-ca
            defaultMode: 0440
            items:
              - key: ca.crt
                path: ca.crt
        - name: teleport-core-postgres-teleport-core-user
          secret:
            secretName: teleport-core-postgres-teleport-core-user
            defaultMode: 0440
            items:
              - key: tls.crt
                path: tls.crt
              - key: tls.key
                path: tls.key
        - name: teleport-audit-postgres-teleport-audit-user
          secret:
            secretName: teleport-audit-postgres-teleport-audit-user
            defaultMode: 0440
            items:
              - key: tls.crt
                path: tls.crt
              - key: tls.key
                path: tls.key
      extraVolumeMounts:
        - name: intermediary-ca-cert
          mountPath: /etc/teleport-backend/secrets/core/server
        - name: teleport-core-postgres-teleport-core-user
          mountPath: /etc/teleport-backend/secrets/core/client
        - name: intermediary-ca-cert
          mountPath: /etc/teleport-backend/secrets/audit/server
        - name: teleport-audit-postgres-teleport-audit-user
          mountPath: /etc/teleport-backend/secrets/audit/client
    proxy:
      teleportConfig:
        proxy_service:
          # TODO limit access to proxy to only gateways per RFD 123:
          # https://github.com/gravitational/teleport/blob/master/rfd/0123-tls-routing-behind-layer7-lb.md
          use_x_forwarded_for: true
    authentication:
      type: oidc
      connectorName: authentik
      localAuth: false
      lockingMode: strict
      secondFactor: off # This is handled by Authentik. TODO consider additional enforcement
    proxyListenerMode: multiplex
    sessionRecording: node-sync
    enterprise: true
    licenseSecretName: teleport-license
    operator:
      enabled: true
    podMonitor:
      enabled: true
    highAvailability:
      replicaCount: 2
      requireAntiAffinity: true
      podDisruptionBudget:
        enabled: true
        minAvailable: 1
      certManager:
        enabled: true
        addCommonName: true
        addPublicAddrs: true
        issuerName: security-intermediary-ca # TODO this is probably wrong (???)
    service:
      type: ClusterIP
    ingress:
      # TODO use httproute
      enabled: true
      # useExisting: true
  postRenderers:
    # Add env vars for audit session logging S3 bucket access
    - kustomize:
        patches:
          - patch: |
              - op: add
                path: /spec/containers/0/envFrom/-
                value:
                  - secretRef:
                      name: teleport-audit-sessions
            target:
              group: apps
              version: v1
              kind: Deployment
              name: teleport-cluster-auth

  # TODO add TSCs
