---
# cspell:words SSLMODE SSLROOTCERT SSLCERT SSLKEY REQS certfile rediss
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app_name authentik
spec:
  interval: 5m
  chart:
    spec:
      chart: authentik
      sourceRef:
        kind: HelmRepository
        name: goauthentik-charts
      version: 2024.10.2
  values:
    global:
      env:
        # Postgres
        ## RW endpoint
        - name: AUTHENTIK_POSTGRESQL__HOST
          value: authentik-postgres-17-rw.security.svc.cluster.local
        - name: AUTHENTIK_POSTGRESQL__NAME
          value: authentik
        - name: AUTHENTIK_POSTGRESQL__USER
          value: authentik
        - name: AUTHENTIK_POSTGRESQL__PORT
          value: "5432"
        - name: AUTHENTIK_POSTGRESQL__SSLMODE
          value: verify-full
        - name: AUTHENTIK_POSTGRESQL__SSLROOTCERT
          value: /etc/authentik/secrets/root-ca-cert/ca.crt
        - name: AUTHENTIK_POSTGRESQL__SSLCERT
          value: /etc/authentik/secrets/postgres-authentik-user/tls.crt
        - name: AUTHENTIK_POSTGRESQL__SSLKEY
          value: /etc/authentik/secrets/postgres-authentik-user/tls.key
        ## RO endpoint
        - name: AUTHENTIK_POSTGRESQL__READ_REPLICAS__0__HOST
          value: authentik-postgres-17-ro.security.svc.cluster.local
        - name: AUTHENTIK_POSTGRESQL__READ_REPLICAS__0__NAME
          value: authentik
        - name: AUTHENTIK_POSTGRESQL__READ_REPLICAS__0__USER
          value: authentik
        - name: AUTHENTIK_POSTGRESQL__READ_REPLICAS__0__PORT
          value: "5432"
        - name: AUTHENTIK_POSTGRESQL__READ_REPLICAS__0__SSLMODE
          value: verify-full
        - name: AUTHENTIK_POSTGRESQL__READ_REPLICAS__0__SSLROOTCERT
          value: /etc/authentik/secrets/root-ca-cert/ca.crt
        - name: AUTHENTIK_POSTGRESQL__READ_REPLICAS__0__SSLCERT
          value: /etc/authentik/secrets/postgres-authentik-user/tls.crt
        - name: AUTHENTIK_POSTGRESQL__READ_REPLICAS__0__SSLKEY
          value: /etc/authentik/secrets/postgres-authentik-user/tls.key
        # Redis
        - name: AUTHENTIK_REDIS__HOST
          value: authentik-dragonfly.security.svc.cluster.local
        - name: AUTHENTIK_REDIS__PORT
          value: "6379"
        - name: AUTHENTIK_REDIS__DB
          value: "0"
        - name: AUTHENTIK_REDIS__TLS
          value: "true"
        - name: AUTHENTIK_REDIS__TLS_REQS
          value: "required"
        # Workaround to provide client auth certs, see https://github.com/goauthentik/authentik/issues/12041
        - name: AUTHENTIK_REDIS__TLS_CA_CERT
          value: /etc/authentik/secrets/root-ca-cert/ca.crt
        - name: AUTHENTIK_RESULT_BACKEND__URL
          value: &redis_connection_url "\
            rediss://\
            $(AUTHENTIK_REDIS__HOST):$(AUTHENTIK_REDIS__PORT)/$(AUTHENTIK_REDIS__DB)?\
            ssl_keyfile=/etc/authentik/secrets/dragonfly-authentik-user/tls.key&\
            ssl_certfile=/etc/authentik/secrets/dragonfly-authentik-user/tls.crt&\
            ssl_cert_reqs=$(AUTHENTIK_REDIS__TLS_REQS)&\
            ssl_ca_certs=$(AUTHENTIK_REDIS__TLS_CA_CERT)\
            "
        - name: AUTHENTIK_CACHE__URL
          value: *redis_connection_url
        - name: AUTHENTIK_CHANNEL__URL
          value: *redis_connection_url
        - name: AUTHENTIK_BROKER__URL
          value: *redis_connection_url
        # Use the right source IP
        # TODO netpol to limit traffic to gateway pods
        - name: AUTHENTIK_LISTEN__TRUSTED_PROXY_CIDRS
          value: 10.32.0.0/16
        # Media file storage
        - name: AUTHENTIK_STORAGE__MEDIA__BACKEND
          value: s3
        - name: AUTHENTIK_STORAGE__MEDIA__S3__USE_SSL
          value: "true"
        - name: AUTHENTIK_STORAGE__MEDIA__S3__SECURE_URLS
          value: "true"
        - name: AUTHENTIK_STORAGE__MEDIA__S3__ENDPOINT
          value: https://$(BUCKET_HOST)
        - name: AUTHENTIK_STORAGE__MEDIA__S3__ACCESS_KEY
          value: $(AWS_ACCESS_KEY_ID)
        - name: AUTHENTIK_STORAGE__MEDIA__S3__SECRET_KEY
          value: $(AWS_SECRET_ACCESS_KEY)
        - name: AUTHENTIK_STORAGE__MEDIA__S3__BUCKET_NAME
          value: $(BUCKET_NAME)
        - name: AUTHENTIK_STORAGE__MEDIA__S3__CUSTOM_DOMAIN
          value: $(BUCKET_HOST).:$(BUCKET_PORT)/$(BUCKET_NAME)
        # Email
        - name: AUTHENTIK_EMAIL__HOST
          value: docker-postfix-mail.email.svc.cluster.local
        - name: AUTHENTIK_EMAIL__PORT
          value: "587"
        - name: AUTHENTIK_EMAIL__USE_TLS
          value: "true"
        - name: AUTHENTIK_EMAIL__FROM
          value: Authentik <no-reply-authentik@${SECRET_PUBLIC_DOMAIN_NAME}>
        # Authentik
        - name: AUTHENTIK_DISABLE_UPDATE_CHECK
          value: "true"
      envFrom:
        - configMapRef:
            name: authentik-media
        - secretRef:
            name: authentik-media
        - secretRef:
            name: authentik-env-values
      volumes:
        - name: root-ca-cert
          secret:
            secretName: security-intermediary-ca
            defaultMode: 0440
            items:
              - key: ca.crt
                path: ca.crt
        - name: postgres-authentik-user
          secret:
            secretName: authentik-postgres-authentik-user
            defaultMode: 0440
            items:
              - key: tls.crt
                path: tls.crt
              - key: tls.key
                path: tls.key
        - name: dragonfly-authentik-user
          secret:
            secretName: authentik-dragonfly-authentik-user
            defaultMode: 0440
            items:
              - key: tls.crt
                path: tls.crt
              - key: tls.key
                path: tls.key
        - name: authentik-python-user-settings
          configMap:
            name: authentik-python-user-settings
            defaultMode: 0440
      volumeMounts:
        - name: root-ca-cert
          mountPath: /etc/authentik/secrets/root-ca-cert
        - name: postgres-authentik-user
          mountPath: /etc/authentik/secrets/postgres-authentik-user
        - name: dragonfly-authentik-user
          mountPath: /etc/authentik/secrets/dragonfly-authentik-user
        - name: authentik-python-user-settings
          mountPath: /data
      securityContext:
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
    server:
      replicas: 2
      pdb:
        enabled: true
      topologySpreadConstraints:
        - maxSkew: 1 # Skew of 1 allows for rolling updates
          topologyKey: kubernetes.io/hostname
          labelSelector:
            matchLabels:
              app.kubernetes.io/instance: *app_name
              app.kubernetes.io/component: server
          whenUnsatisfiable: DoNotSchedule
      metrics:
        enabled: true
        serviceMonitor:
          enabled: true
    worker:
      replicas: 2
      pdb:
        enabled: true
      topologySpreadConstraints:
        - maxSkew: 1 # Skew of 1 allows for rolling updates
          topologyKey: kubernetes.io/hostname
          labelSelector:
            matchLabels:
              app.kubernetes.io/instance: *app_name
              app.kubernetes.io/component: worker
          whenUnsatisfiable: DoNotSchedule
    geoip:
      enabled: false
      existingSecret:
        secretName: authentik-geoip-credentials
    prometheus:
      rules:
        enabled: true
