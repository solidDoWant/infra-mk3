---
# cspell:words SSLMODE SSLROOTCERT SSLCERT SSLKEY REQS certfile
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: authentik
spec:
  interval: 5m
  chart:
    spec:
      chart: authentik
      sourceRef:
        kind: HelmRepository
        name: goauthentik-charts
      version: 2024.10.2
  values:
    global:
      env:
        # Postgres
        ## RW endpoint
        - name: AUTHENTIK_POSTGRESQL__HOST
          value: authentik-postgres-17-rw.security.svc.cluster.local.
        - name: AUTHENTIK_POSTGRESQL__NAME
          value: authentik
        - name: AUTHENTIK_POSTGRESQL__USER
          value: authentik
        - name: AUTHENTIK_POSTGRESQL__PORT
          value: "5432"
        - name: AUTHENTIK_POSTGRESQL__SSLMODE
          value: verify-full
        - name: AUTHENTIK_POSTGRESQL__SSLROOTCERT
          value: /etc/authentic/secrets/root-ca-cert/ca.crt
        - name: AUTHENTIK_POSTGRESQL__SSLCERT
          value: /etc/authentic/secrets/postgres-authentik-user/tls.crt
        - name: AUTHENTIK_POSTGRESQL__SSLKEY
          value: /etc/authentic/secrets/postgres-authentik-user/tls.key
        ## RO endpoint
        - name: AUTHENTIK_POSTGRESQL__READ_REPLICAS__0__HOST
          value: authentik-postgres-17-ro.security.svc.cluster.local.
        - name: AUTHENTIK_POSTGRESQL__READ_REPLICAS__0__NAME
          value: authentik
        - name: AUTHENTIK_POSTGRESQL__READ_REPLICAS__0__USER
          value: authentik
        - name: AUTHENTIK_POSTGRESQL__READ_REPLICAS__0__PORT
          value: "5432"
        - name: AUTHENTIK_POSTGRESQL__READ_REPLICAS__0__SSLMODE
          value: verify-full
        - name: AUTHENTIK_POSTGRESQL__READ_REPLICAS__0__SSLROOTCERT
          value: /etc/authentic/secrets/root-ca-cert/ca.crt
        - name: AUTHENTIK_POSTGRESQL__READ_REPLICAS__0__SSLCERT
          value: /etc/authentic/secrets/postgres-authentik-user/tls.crt
        - name: AUTHENTIK_POSTGRESQL__READ_REPLICAS__0__SSLKEY
          value: /etc/authentic/secrets/postgres-authentik-user/tls.key
        # Redis
        - name: AUTHENTIK_REDIS__HOST
          value: authentik-dragonfly.security.svc.cluster.local.
        - name: AUTHENTIK_REDIS__PORT
          value: "6379"
        - name: AUTHENTIK_REDIS__TLS
          value: "true"
        - name: AUTHENTIK_REDIS__TLS_REQS
          value: "required"
        # Workaround to provide client auth certs, see https://github.com/goauthentik/authentik/issues/12041
        - name: AUTHENTIK_REDIS__TLS_CA_CERT
          value: "
            /etc/authentic/secrets/root-ca-cert/ca.crt&\
            ssl_certfile=/etc/authentic/secrets/dragonfly-authentik-user/tls.crt&\
            ssl_keyfile=/etc/authentic/secrets/dragonfly-authentik-user/tls.key\
            "
        # Use the right source IP
        # TODO netpol to limit traffic to gateway pods
        - name: AUTHENTIK_LISTEN__TRUSTED_PROXY_CIDRS
          value: 10.32.0.0/16
        # Media file storage
        - name: AUTHENTIK_STORAGE__MEDIA__BACKEND
          value: s3
        - name: AUTHENTIK_STORAGE__MEDIA__S3__USE_SSL
          value: "true"
        - name: AUTHENTIK_STORAGE__MEDIA__S3__SECURE_URLS
          value: "true"
        - name: AUTHENTIK_STORAGE__MEDIA__S3__ENDPOINT
          value: https://$(BUCKET_HOST).
        - name: AUTHENTIK_STORAGE__MEDIA__S3__ACCESS_KEY
          value: $(AWS_ACCESS_KEY_ID)
        - name: AUTHENTIK_STORAGE__MEDIA__S3__SECRET_KEY
          value: $(AWS_SECRET_ACCESS_KEY)
        - name: AUTHENTIK_STORAGE__MEDIA__S3__BUCKET_NAME
          value: $(BUCKET_NAME)
        - name: AUTHENTIK_STORAGE__MEDIA__S3__CUSTOM_DOMAIN
          value: $(BUCKET_HOST).:$(BUCKET_PORT)/$(BUCKET_NAME)
        # Email
        - name: AUTHENTIK_EMAIL__HOST
          value: docker-postfix-mail.email.svc.cluster.local.
        - name: AUTHENTIK_EMAIL__PORT
          value: "587"
        - name: AUTHENTIK_EMAIL__USE_TLS
          value: "true"
        - name: AUTHENTIK_EMAIL__FROM
          value: Authentik <no-reply-authentik@${SECRET_PUBLIC_DOMAIN_NAME}>
        # Authentik
        - name: AUTHENTIK_DISABLE_UPDATE_CHECK
          value: "true"
      envFrom:
        - configMapRef:
          name: authentik-media
        - secretRef:
          name: authentik-media
        - secretRef:
          name: env-values
      volumes:
        - name: root-ca-cert
          secret:
            secretName: security-intermediary-ca
            defaultMode: 0400
            items:
              - key: ca.crt
                path: ca.crt
        - name: postgres-authentik-user
          secret:
            secretName: authentik-postgres-authentik-user
            defaultMode: 0400
            items:
              - key: tls.crt
                path: tls.crt
              - key: tls.key
                path: tls.key
        - name: dragonfly-authentik-user
          secret:
            secretName: authentik-dragonfly-authentik-user
            defaultMode: 0400
            items:
              - key: tls.crt
                path: tls.crt
              - key: tls.key
                path: tls.key
      volumeMounts:
        - name: root-ca-cert
          mountPath: /etc/authentic/secrets/root-ca-cert
        - name: postgres-authentik-user
          mountPath: /etc/authentic/secrets/postgres-authentik-user
        - name: dragonfly-authentik-user
          mountPath: /etc/authentic/secrets/dragonfly-authentik-user
    # authentik:
    #   secret_key:
    # email:
    #   host:
    #   use_tls: true
    #   from: no-reply-authentik@${SECRET_PUBLIC_DOMAIN_NAME}
    # postgresql:
    #   host:
    # redis:
    #   host:
    server:
      replicas: 2
      pdb:
        enabled: true
      # env:
      # topologySpreadConstraints:
      metrics:
        enabled: true
        serviceMonitor:
          enabled: true
      # ingress:  # TODO httproute
    worker:
      replicas: 2
      pdb:
        enabled: true
      # topologySpreadConstraints:
    geoip:
      enabled: true
      existingSecret:
        secretName: authentik-geoip-credentials
    prometheus:
      rules:
        enabled: true
