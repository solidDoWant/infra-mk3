---
# yaml-language-server: $schema=https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/dragonflydb.io/dragonfly_v1alpha1.json
apiVersion: dragonflydb.io/v1alpha1
kind: Dragonfly
metadata:
  # The "dragonfly" suffix is needed so that the pods are named uniquely.
  # The created statefulset will match the cluster name exactly, which
  # can conflict with the application itself.
  name: authentik-dragonfly
spec:
  replicas: 2
  labels:
    app.kubernetes.io/instance: authentik-dragonfly
  args:
    - --proactor_threads=2 # Dragonfly requires 256MB of RAM per core
  authentication:
    clientCaCertSecret:
      key: ca.crt
      name: authentik-dragonfly-auth-ca-cert
  tlsSecretRef:
    name: authentik-dragonfly-serving-cert
  topologySpreadConstraints:
    - maxSkew: 1
      topologyKey: kubernetes.io/hostname
      labelSelector:
        matchLabels:
          app: authentik-dragonfly
      whenUnsatisfiable: DoNotSchedule
  resources:
    requests:
      cpu: 100m
      # Needs (thread_count * 256Mi) / 0.8
      memory: 640Mi
    limits:
      memory: 640Mi
