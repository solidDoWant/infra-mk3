---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: istio-gateway
spec:
  interval: 1h
  chart:
    spec:
      chart: gateway
      reconcileStrategy: ChartVersion
      sourceRef:
        kind: HelmRepository
        name: istio-charts
      version: 1.23.3
  values:
    profile: ambient
    caAddress: cert-manager-istio-csr.istio-system.svc.cluster.local.:443
    service:
      loadBalancerIP: 10.34.0.1
      externalTrafficPolicy: Local
    autoscaling:
      minReplicas: 2
    topologySpreadConstraints:
      - maxSkew: 1 # Skew of 1 allows for rolling updates
        topologyKey: kubernetes.io/hostname
        labelSelector:
          matchLabels:
            app.kubernetes.io/instance: istio
            app.kubernetes.io/component: gateway
        whenUnsatisfiable: DoNotSchedule
    podDisruptionBudget:
      minAvailable: 1
    priorityClassName: system-cluster-critical
    # Dumb chart is missing resource-specific label fields
    labels:
      patches.flux.home.arpa/deployment.ignore-replicas: "true"
      app.kubernetes.io/instance: istio
      app.kubernetes.io/component: gateway
