---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/kustomization-kustomize-v1.json
# This is the root fluxtomization that pulls in all others (and itself)
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: infra-mk3
spec:
  interval: 5m
  prune: true
  sourceRef:
    kind: GitRepository
    name: infra-mk3
  targetNamespace: flux-system
  dependsOn:
    - name: flux-sources
  patches:
    # Disable pruning of namespaces
    - patch: |
        # Strategic merge patches need these set but the values don't matter at all
        apiVersion: placeholder-value-does-not-matter
        kind: placeholder-value-does-not-matter
        metadata:
          name: placeholder-value-does-not-matter
          labels:
            kustomize.toolkit.fluxcd.io/prune: disabled
      target:
        version: v1
        kind: Namespace
        labelSelector: patches.flux.home.arpa/namespace.can-prune = true
    # Put all fluxtomizations in the flux-system namespace
    - patch: |
        - op: add
          path: /metadata/namespace
          value: flux-system
      target: &fluxtomization_target
        group: kustomize.toolkit.fluxcd.io
        version: v1
        kind: Kustomization
    # These are "meta patches". Rather than directly patch HelmReleases, they
    # patch fluxtomizations to add patches that patch HelmReleases.
    # Add a patch that adds default values to HelmReleases
    - patch: |
        apiVersion: placeholder-value-does-not-matter
        kind: placeholder-value-does-not-matter
        metadata:
          name: placeholder-value-does-not-matter
        spec:
          patches:
            - patch: |
                apiVersion: placeholder-value-does-not-matter
                kind: placeholder-value-does-not-matter
                metadata:
                  name: placeholder-value-does-not-matter
                spec:
                  install:
                    remediation:
                      retries: 5
                  upgrade:
                    remediation:
                      retries: 5
                      strategy: rollback
                    cleanupOnFail: true
                  rollback:
                    recreate: true
                  uninstall:
                    deletionPropagation: foreground
                  driftDetection:
                    mode: enabled
              target:
                group: v2
                version: helm.toolkit.fluxcd.io
                kind: HelmRelease
                labelSelector: patches.flux.home.arpa/helmrelease.defaults != false
      target: *fluxtomization_target
    - patch: |
        apiVersion: placeholder-value-does-not-matter
        kind: placeholder-value-does-not-matter
        metadata:
          name: placeholder-value-does-not-matter
        spec:
          patches:
            - patch: |
                apiVersion: placeholder-value-does-not-matter
                kind: placeholder-value-does-not-matter
                metadata:
                  name: placeholder-value-does-not-matter
                spec:
                  chart:
                    spec:
                      sourceRef:
                        namespace: flux-system
              target:
                group: v2
                version: helm.toolkit.fluxcd.io
                kind: HelmRelease
                labelSelector: patches.flux.home.arpa/helmrelease.default-src-namespace != false
      target: *fluxtomization_target
    # Add a patch that adds a patch that allows drift detection to ignore the
    # desired number of replicas on deployments and statefulsets
    # This is another level of meta patching
    - patch: |
        apiVersion: placeholder-value-does-not-matter
        kind: placeholder-value-does-not-matter
        metadata:
          name: placeholder-value-does-not-matter
        spec:
          patches:
            - patch: |
                apiVersion: placeholder-value-does-not-matter
                kind: placeholder-value-does-not-matter
                metadata:
                  name: placeholder-value-does-not-matter
                spec:
                  driftDetection:
                    ignore:
                      # Ignore deployment replica counts, opt-in (needed for horizontal autoscaling)
                      - paths:
                          - /spec/replicas
                        target:
                          group: apps
                          version: v1
                          kind: Deployment
                          labelSelector: patches.flux.home.arpa/deployment.ignore-replicas = true
                      # Ignore statefulset replica counts, opt-in (needed for horizontal autoscaling)
                      - paths:
                          - /spec/replicas
                        target:
                          group: apps
                          version: v1
                          kind: StatefulSet
                          labelSelector: patches.flux.home.arpa/statefulset.ignore-replicas = true
              target:
                group: v2
                version: helm.toolkit.fluxcd.io
                kind: HelmRelease
      target: *fluxtomization_target
