---
# Install the operator via the manifest for the version's release.
# TODO when/if kubevirt ever makes progress on the Helm chart, switch to that.
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - https://github.com/kubevirt/kubevirt/releases/download/v1.6.2/kubevirt-operator.yaml
  - https://github.com/kubevirt/containerized-data-importer/releases/download/v1.63.1/cdi-operator.yaml
  - ./netpol.yaml
  - ./pdbs.yaml
patches:
  # Why do some tools insist on trying to create their own namespaces???
  - patch: |-
      $patch: delete
      apiVersion: placeholder-value-does-not-matter
      kind: placeholder-value-does-not-matter
      metadata:
        name: placeholder-value-does-not-matter
    target:
      kind: Namespace
  # Fix missing items on the CDI operator deployment
  - patch: |-
      # Set replicas to 2
      - op: replace
        path: /spec/replicas
        value: 2
      # Change strategy to RollingUpdate
      - op: replace
        path: /spec/strategy
        value:
          type: RollingUpdate
      # Add probes
      - op: add
        path: /spec/template/spec/containers/0/livenessProbe
        value:
          httpGet:
            path: /metrics
            port: 8443
            scheme: HTTPS
          initialDelaySeconds: 5
      - op: add
        path: /spec/template/spec/containers/0/readinessProbe
        value:
          httpGet:
            path: /metrics
            port: 8443
            scheme: HTTPS
          initialDelaySeconds: 5
      # Add ports
      - op: add
        path: /spec/template/spec/containers/0/ports
        value:
          - name: metrics
            containerPort: 8443
            protocol: TCP
    target:
      group: apps
      version: v1
      kind: Deployment
      name: cdi-operator
