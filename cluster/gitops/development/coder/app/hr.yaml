---
# yaml-language-server: $schema=https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: coder
spec:
  interval: 5m
  chart:
    spec:
      chart: coder
      reconcileStrategy: ChartVersion
      sourceRef:
        kind: HelmRepository
        namespace: flux-system
        name: coder-charts
      version: 2.28.3
  valuesFrom:
    - kind: Secret
      name: coder-helm-values
  values:
    coder:
      image:
        pullSecrets:
          - name: coder-pull-credentials
      securityContext:
        readOnlyRootFilesystem: true
      podLabels:
        endpoints.netpols.home.arpa/email-sender: "true"
      serviceAccount:
        extraRules:
          - apiGroups:
              - ""
            resources:
              - secrets
            resourceNames:
              - coder-claude-oauth-token
            verbs:
              - get
          # Rule to manage CiliumNetworkPolicy objects for workspaces
          - apiGroups:
              - cilium.io
            resources:
              - ciliumnetworkpolicies
            verbs:
              - "*"
      podSecurityContext:
        fsGroup: 1000
      volumes:
        - name: postgres-user-cert
          secret:
            secretName: coder-postgres-coder-user
            items:
              - key: tls.crt
                path: tls.crt
              - key: tls.key
                path: tls.key
            defaultMode: 0400
        - name: postgres-serving-cert
          secret:
            secretName: coder-postgres-17-serving-cert
            items:
              - key: tls.crt
                path: tls.crt
            defaultMode: 0400
        - name: coder-startup
          image:
            reference: harbor.${SECRET_PUBLIC_DOMAIN_NAME}/coder/coder-startup:0.0.2
        - name: temp
          emptyDir:
            sizeLimit: 1Gi
      volumeMounts:
        - name: postgres-user-cert
          mountPath: /etc/coder/certs/postgres/user
          readOnly: true
        - name: postgres-serving-cert
          mountPath: /etc/coder/certs/postgres/serving
          readOnly: true
        - name: coder-startup
          mountPath: /coder-startup
          readOnly: true
        - name: temp
          mountPath: /tmp
          subPath: tmp
        - name: temp
          mountPath: /home/coder/.cache
          subPath: cache
      resources: {}
      service:
        type: ClusterIP
      command:
        - /coder-startup/coder-startup
