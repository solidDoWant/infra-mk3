---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: coder
rules:
  # Access to list CRDs for the Kubernetes Terraform provider
  - apiGroups:
      - apiextensions.k8s.io
    resources:
      - customresourcedefinitions
    verbs:
      - list
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: coder
subjects:
  - kind: ServiceAccount
    namespace: development
    name: coder
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: coder
---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: restrict-coder-netpol-access
spec:
  background: false
  rules:
    - name: deny-coder-sa-non-coder-netpol-access
      match:
        resources:
          kinds:
            - CiliumNetworkPolicy
          namespaces:
            - development
      validate:
        failureAction: Enforce
        message: The Coder service account can only modify CiliumNetworkPolicies for Coder Workspaces.
        deny:
          conditions:
            all:
              - key: >-
                  {{ request.userInfo.username }}
                operator: Equals
                value: system:serviceaccount:development:coder
              - key: >-
                  {{ request.object.metadata.labels."app.kubernetes.io/name" || "" }}
                operator: NotEquals
                value: coder-workspace
