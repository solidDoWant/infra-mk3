---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: harbor
spec:
  interval: 5m
  chart:
    spec:
      chart: harbor
      reconcileStrategy: ChartVersion
      sourceRef:
        kind: HelmRepository
        namespace: flux-system
        name: harbor-charts
      version: 1.18.0
  valuesFrom:
    - kind: ConfigMap
      name: harbor-registry-bucket-hr-config
      valuesKey: regionendpoint
      targetPath: persistence.imageChartStorage.s3.regionendpoint
    - kind: ConfigMap
      name: harbor-registry-bucket-hr-config
      valuesKey: bucket
      targetPath: persistence.imageChartStorage.s3.bucket
  # This is not HA. The HA support is pretty terrible and is missing a support for a ton of basic features
  # like mTLS DB auth and redis failover. Run with a single instance of each component until I get time to
  # fix this mess.
  values:
    expose:
      type: route
      tls:
        # This is a bug. tls.enabled should only be true when ingress is used, not gateway API.
        enabled: false
      route:
        hosts:
          - harbor.${SECRET_PUBLIC_DOMAIN_NAME}
        parentRefs:
          - name: internal-gateway
            namespace: networking
    externalURL: https://harbor.${SECRET_PUBLIC_DOMAIN_NAME}
    persistence:
      resourcePolicy: ""
      imageChartStorage:
        # Disable S3 redirect for now while I sort out access requirements
        disableredirect: true
        type: s3
        s3:
          # Bucket and endpoint are set via valuesFrom above
          existingSecret: harbor-registry-bucket-credentials
    existingSecretAdminPassword: harbor-admin-credentials
    ipFamily:
      ipv6:
        enabled: false
    logLevel: debug
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
    portal:
      replicas: 2
    core:
      replicas: 2
      extraEnvVars:
        # This could alternatively be set via `configureUserSettings`, but this doesn't play nice with flux var substitution because the value is a JSON object
        - name: CONFIG_OVERWRITE_JSON
          valueFrom:
            secretKeyRef:
              name: harbor-authentication-config
              key: configureUserSettings
      initContainers:
        - &envoy_sidecar
          name: envoy
          # Contrib image is required because the postgres filter extension is only in the contrib build
          image: envoyproxy/envoy:contrib-v1.35.3
          ports:
            - name: envoy-admin
              containerPort: 8000
          securityContext:
            capabilities:
              drop:
                - ALL
            privileged: false
            runAsNonRoot: true
            allowPrivilegeEscalation: false
            seccompProfile:
              type: RuntimeDefault
          volumeMounts:
            - name: envoy-config
              mountPath: /etc/envoy
            - name: postgres-cert
              mountPath: /etc/envoy/secrets/postgres
            - name: redis-cert
              mountPath: /etc/envoy/secrets/redis
            - name: root-ca
              mountPath: /etc/envoy/secrets/root-ca
          restartPolicy: Always
    jobservice:
      replicas: 2
      jobLoggers:
        - database # TODO I might be able to remove this
        - stdout
      initContainers:
        - *envoy_sidecar
    registry:
      replicas: 2
      credentials:
        username: harbor-internal
        password: ""
        existingSecret: harbor-internal-registry-credentials
    trivy:
      replicas: 2
      resources:
        requests:
          memory: 256Mi
        limits:
          memory: 256Mi
      ignoreUnfixed: true
      initContainers:
        - <<: *envoy_sidecar
          volumeMounts:
            - name: envoy-config
              mountPath: /etc/envoy
            - name: redis-cert
              mountPath: /etc/envoy/secrets/redis
            - name: root-ca
              mountPath: /etc/envoy/secrets/root-ca
    database:
      type: external
      external:
        # This uses the password auth, and no TLS. Envoy sidecars on all pods that access the DB
        # will proxy the DB connections and authenticate via mTLS.
        host: 127.0.0.1
        username: harbor
        coreDatabase: harbor
        maxOpenConns: 50
        maxIdleConns: 10
    redis:
      type: external
      external:
        # See above DB note about Envoy sidecar for mTLS
        addr: 127.0.0.1:6379
        # Envoy has a pretty nasty bug with db 0, so use a different one
        # See https://github.com/envoyproxy/envoy/issues/41659
        coreDatabaseIndex: "6"
    exporter:
      # TODO, this will require changing the ServiceMonitor to avoid metric duplication
      # replicas: 2
  postRenderers:
    # Add the cert and envoy config volumes to envoy sidecars
    - kustomize:
        patches:
          - patch: |
              # Add the postgres user cert volume
              - op: add
                path: /spec/template/spec/volumes/-
                value:
                  name: postgres-cert
                  secret:
                    secretName: harbor-postgres-harbor-user
                    items:
                      - key: tls.crt
                        path: tls.crt
                      - key: tls.key
                        path: tls.key
                    defaultMode: 0440
              # Add the redis user cert volume
              - op: add
                path: /spec/template/spec/volumes/-
                value:
                  name: redis-cert
                  secret:
                    secretName: harbor-dragonfly-harbor-user
                    items:
                      - key: tls.crt
                        path: tls.crt
                      - key: tls.key
                        path: tls.key
                    defaultMode: 0440
              # Add the root CA cert volume
              - op: add
                path: /spec/template/spec/volumes/-
                value:
                  name: root-ca
                  secret:
                    secretName: root-ca-pub-cert
                    items:
                      - key: ca.crt
                        path: ca.crt
                    defaultMode: 0444
              # Add the envoy config volume
              - op: add
                path: /spec/template/spec/volumes/-
                value:
                  name: envoy-config
                  configMap:
                    name: harbor-envoy-pg-redis-config
                    defaultMode: 0440
            target:
              group: apps
              version: v1
              kind: Deployment
              name: harbor-core
    - kustomize:
        patches:
          - patch: |
              # Add the postgres user cert volume
              - op: add
                path: /spec/template/spec/volumes/-
                value:
                  name: postgres-cert
                  secret:
                    secretName: harbor-postgres-harbor-user
                    items:
                      - key: tls.crt
                        path: tls.crt
                      - key: tls.key
                        path: tls.key
                    defaultMode: 0440
              # Add the redis user cert volume
              - op: add
                path: /spec/template/spec/volumes/-
                value:
                  name: redis-cert
                  secret:
                    secretName: harbor-dragonfly-harbor-user
                    items:
                      - key: tls.crt
                        path: tls.crt
                      - key: tls.key
                        path: tls.key
                    defaultMode: 0440
              # Add the root CA cert volume
              - op: add
                path: /spec/template/spec/volumes/-
                value:
                  name: root-ca
                  secret:
                    secretName: root-ca-pub-cert
                    items:
                      - key: ca.crt
                        path: ca.crt
                    defaultMode: 0444
              # Add the envoy config volume
              - op: add
                path: /spec/template/spec/volumes/-
                value:
                  name: envoy-config
                  configMap:
                    name: harbor-envoy-pg-redis-config
                    defaultMode: 0440
            target:
              group: apps
              version: v1
              kind: Deployment
              name: harbor-jobservice
    - kustomize:
        patches:
          - patch: |
              # Add an empty volume list
              - op: add
                path: /spec/template/spec/volumes
                value: []
              # Add the redis user cert volume
              - op: add
                path: /spec/template/spec/volumes/-
                value:
                  name: redis-cert
                  secret:
                    secretName: harbor-dragonfly-harbor-user
                    items:
                      - key: tls.crt
                        path: tls.crt
                      - key: tls.key
                        path: tls.key
                    defaultMode: 0440
              # Add the root CA cert volume
              - op: add
                path: /spec/template/spec/volumes/-
                value:
                  name: root-ca
                  secret:
                    secretName: root-ca-pub-cert
                    items:
                      - key: ca.crt
                        path: ca.crt
                    defaultMode: 0444
              # Add the envoy config volume
              - op: add
                path: /spec/template/spec/volumes/-
                value:
                  name: envoy-config
                  configMap:
                    name: harbor-envoy-redis-only-config
                    defaultMode: 0440
            target:
              group: apps
              version: v1
              kind: StatefulSet
              name: harbor-trivy
    # This deployment does not support `initContainers`, so a patch is needed for it here as well
    - kustomize:
        patches:
          - patch: |
              # Add the postgres user cert volume
              - op: add
                path: /spec/template/spec/volumes/-
                value:
                  name: postgres-cert
                  secret:
                    secretName: harbor-postgres-harbor-user
                    items:
                      - key: tls.crt
                        path: tls.crt
                      - key: tls.key
                        path: tls.key
                    defaultMode: 0440
              # Add the redis user cert volume
              - op: add
                path: /spec/template/spec/volumes/-
                value:
                  name: redis-cert
                  secret:
                    secretName: harbor-dragonfly-harbor-user
                    items:
                      - key: tls.crt
                        path: tls.crt
                      - key: tls.key
                        path: tls.key
                    defaultMode: 0440
              # Add the root CA cert volume
              - op: add
                path: /spec/template/spec/volumes/-
                value:
                  name: root-ca
                  secret:
                    secretName: root-ca-pub-cert
                    items:
                      - key: ca.crt
                        path: ca.crt
                    defaultMode: 0444
              # Add the envoy config volume
              - op: add
                path: /spec/template/spec/volumes/-
                value:
                  name: envoy-config
                  configMap:
                    name: harbor-envoy-pg-redis-config
                    defaultMode: 0440
              # Add the envoy sidecar init container
              - op: add
                path: /spec/template/spec/initContainers
                value:
                  - name: envoy
                    # Contrib image is required because the postgres filter extension is only in the contrib build
                    image: envoyproxy/envoy:contrib-v1.35.3
                    ports:
                      - name: envoy-admin
                        containerPort: 8000
                    securityContext:
                      capabilities:
                        drop:
                          - ALL
                      privileged: false
                      runAsNonRoot: true
                      allowPrivilegeEscalation: false
                      seccompProfile:
                        type: RuntimeDefault
                    volumeMounts:
                      - name: envoy-config
                        mountPath: /etc/envoy
                      - name: postgres-cert
                        mountPath: /etc/envoy/secrets/postgres
                      - name: redis-cert
                        mountPath: /etc/envoy/secrets/redis
                      - name: root-ca
                        mountPath: /etc/envoy/secrets/root-ca
                    restartPolicy: Always
            target:
              group: apps
              version: v1
              kind: Deployment
              name: harbor-exporter
