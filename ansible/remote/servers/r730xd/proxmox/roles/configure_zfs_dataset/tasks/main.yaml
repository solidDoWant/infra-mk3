---
- name: Check if the dataset already exists
  command: zfs list {{ pool_name }}/{{ dataset_name }}
  ignore_errors: true
  register: zfs_list

- name: Create the dataset
  command: >-
    zfs create
    {{ pool_name }}/{{ dataset_name }}
    {%- if share_with_nfs %}
    -o sharenfs='all_squash,anonuid=2000,anongid=2000,{{ nfs_subnets | map("printf", "rw=@%s") | join "," }}'
    {%- end %}
    {{ "-o sharenfs='all_squash,anonuid=2000,anongid=2000,rw=@10.0.0.0/8'" if share_with_nfs }}
    {{ "-o sync=disabled" if force_sync_writes }}
  when: zfs_list.rc != 0
