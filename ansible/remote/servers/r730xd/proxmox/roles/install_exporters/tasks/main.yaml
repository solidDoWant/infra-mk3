---
- name: Node exporter
  block:
    - name: Check if an IPMI device exists
      ansible.builtin.stat:
        path: /sys/class/ipmi
      register: ipmi_class
      changed_when: false
    - name: Install IPMI dependencies
      ansible.builtin.apt:
        name:
          - ipmitool
        state: latest
        update_cache: true
        cache_valid_time: 600
        autoclean: true
        autoremove: true
      when: ipmi_class.stat.exists
    - name: Install node-exporter, collectors, and dependencies
      ansible.builtin.apt:
        name:
          - prometheus-node-exporter
          - prometheus-node-exporter-collectors
          - nvme-cli
          - smartmontools
        state: latest
        update_cache: true
        cache_valid_time: 600
        autoclean: true
        autoremove: true
    - name: Configure node-exporter
      ansible.builtin.copy:
        dest: /etc/default/prometheus-node-exporter
        content: |
          ARGS="--web.listen-address={{listening_address}}:9100"    
        owner: root
        group: root
        mode: 0644
      register: config_file
    - name: Restart the prometheus-node-exporter service
      ansible.builtin.systemd:
        name: prometheus-node-exporter
        state: restarted
      when: config_file.changed
    # This is all kinds of broken on nvme-cli v2.8
    # This PR fixed compat with v2.11 and broke everything earlier:
    # https://github.com/prometheus-community/node-exporter-textfile-collector-scripts/pull/227
    - name: Disable the prometheus-node-exporter-nvme timer
      ansible.builtin.systemd:
        name: prometheus-node-exporter-nvme.timer
        enabled: false
        state: stopped
